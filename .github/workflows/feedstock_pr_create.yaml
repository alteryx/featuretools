on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      pypi_version:
        description: 'released PyPI version to use'
        required: true
        
name: Create Feedstock PR
jobs:
  create_feedstock_pr:
    name: Create Feedstock PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout published version
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: "v1.12.0"
          path: "./featuretools"
      - if: ${{ github.event.inputs.pypi_version }}
        name: Checkout inputted version
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.inputs.pypi_version }}
          path: "./featuretools"
      - name: Pull latest from upstream for user forked feedstock
        run: |
          gh auth status
          gh repo fork conda-forge/featuretools-feedstock --clone
          gh repo sync machineAYX/featuretools-feedstock --branch main --source conda-forge/featuretools-feedstock --branch main --force
        env:
          GITHUB_TOKEN: ${{ secrets.AUTO_APPROVE_TOKEN }}
      - uses: actions/checkout@v3
        with:
          repository: machineAYX/featuretools-feedstock
          ref: main
          path: "./featuretools-feedstock"
          fetch-depth: '0'
      - name: list files
        run: ls
      - name: Run Create Feedstock meta YAML
        id: create-feedstock-meta
        uses: alteryx/create-feedstock-meta-yaml@v3
        with:
          project: "featuretools"
          pypi_version: "v1.12.0"
          setup_cfg_filepath: "featuretools/setup.cfg"
          meta_yaml_filepath: "featuretools-feedstock/recipe/meta.yaml"
          add_to_test_requirements: "graphviz !=2.47.2"
      - name: view updated meta yaml
        run: |
          ls
          cat featuretools-feedstock/recipe/meta.yaml
      - name: git config
        run: |
          cd featuretools-feedstock/
          git config user.name "machineAYX Bot"
          git config user.email "<>"
      - name: add and commit
        run: |
          cd featuretools-feedstock/
          git status
          git checkout -b conda-autocreate
          git add recipe/meta.yaml
          git commit -m "This is an auto-generated commit."
        env:
          GITHUB_TOKEN: ${{ secrets.AUTO_APPROVE_TOKEN }}
      - name: push
        run: |
          gh pr create --base main --repo conda-forge/featuretools-feedstock --title "v1.12.0" --body "This is an auto-generated PR." --head machineAYX:conda-autocreate
        env:
          GITHUB_TOKEN: ${{ secrets.AUTO_APPROVE_TOKEN }}
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          path: featuretools-feedstock/
          token: ${{ secrets.AUTO_APPROVE_TOKEN }}
          commit-message: "v1.12.0"
          title: "v1.12.0"
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          body: "This is an auto-generated PR."
          branch: conda-autocreate
          branch-suffix: short-commit-hash
          base: main
          push-to-fork: conda-forge/featuretools-feedstock
